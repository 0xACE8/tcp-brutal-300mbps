steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Version Variable
        id: set_vars
        run: |
          # 统一逻辑：无论是 Tag 触发还是手动输入，都存入 VERSION 环境变量
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag_name }}" >> $GITHUB_ENV
          else
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      - name: Build and Release
        run: |
          echo "正在构建版本: ${{ env.VERSION }}"
          # 这里的构建命令可以使用 ${{ env.VERSION }}

      - name: Package Source Code
        run: |
          # --- 自定义配置区域 ---
          CUSTOM_PKG_NAME="tcp-brutal-300Mbps"
          
          # 核心修复：直接读取第一步设置好的环境变量，不要再判断 REF_TYPE 了
          # 这里的操作是移除 'v' 前缀 (例如 v1.0.3 -> 1.0.3)
          RAW_VERSION="${{ env.VERSION }}"
          PURE_VERSION="${RAW_VERSION#v}"
          
          echo "处理后的纯数字版本号: $PURE_VERSION"
          
          # 最终的目录名: tcp-brutal-300Mbps-1.0.3
          DIR_NAME="${CUSTOM_PKG_NAME}-${PURE_VERSION}"
          
          echo "Packaging source into: $DIR_NAME"
          
          # 1. 创建结构
          mkdir -p dist/$DIR_NAME
          
          # 2. 复制源码
          rsync -av --exclude='.git' --exclude='.github' --exclude='dist' . dist/$DIR_NAME/
          
          # 3. 打包
          cd dist
          tar -czvf ${DIR_NAME}.tar.gz $DIR_NAME
          zip -r ${DIR_NAME}.zip $DIR_NAME
          
          # 4. 导出变量
          echo "ASSET_TAR=dist/${DIR_NAME}.tar.gz" >> $GITHUB_ENV
          echo "ASSET_ZIP=dist/${DIR_NAME}.zip" >> $GITHUB_ENV
          # Release 标题依然保留带 v 的版本号
          echo "RELEASE_NAME=${CUSTOM_PKG_NAME}-${RAW_VERSION}" >> $GITHUB_ENV

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          # 修复点：显式指定 Tag 名称，否则手动触发时会报错
          tag_name: ${{ env.VERSION }}
          name: ${{ env.RELEASE_NAME }}
          draft: false
          prerelease: false
          files: |
            ${{ env.ASSET_TAR }}
            ${{ env.ASSET_ZIP }}
